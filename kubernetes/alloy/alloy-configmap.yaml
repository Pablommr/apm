apiVersion: v1
kind: ConfigMap
metadata:
  name: alloy-configmap
  namespace: monitoring
data:
  config.alloy: |-
    otelcol.processor.memory_limiter "default" {
      check_interval = "1s"
      limit          = "256MiB"


      output {
        metrics = [otelcol.processor.batch.grafana_tempo.input,]
      }
    }

    otelcol.receiver.otlp "otlp_receiver" {
      grpc {
        endpoint = "0.0.0.0:4317"
      }

      http {
        endpoint = "0.0.0.0:4318"
      }
    
      output {
        traces = [otelcol.processor.batch.grafana_tempo.input,]
      }
    }
    
    otelcol.processor.k8sattributes "grafana_tempo" {
      extract {
        metadata = [
          "k8s.namespace.name",
          "k8s.pod.name",
          "k8s.container.name",
        ]
      }

      output {
        traces = [otelcol.processor.batch.grafana_tempo.input,]
      }
    }

    otelcol.processor.batch "grafana_tempo" {
      output {
        traces = [otelcol.exporter.otlp.grafana_tempo.input,]
      }
    }

    otelcol.exporter.otlp "grafana_tempo" {
      client {
        endpoint = "distributor-service:4317"
        tls {
    			insecure = true
    		}
      }

      sending_queue {
        enabled = true
        num_consumers = 20
        queue_size = 3000
      }
    }

    logging {
      level  = "debug"
      format = "json"
    }